---
title: "diet"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{diet}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  comment = "#>"
)
```

```{r setup}
library(mbtransfer)
library(tidyverse)
library(glue)
library(tidymodels)
```

```{r}
subject <- read_csv("https://figshare.com/ndownloader/files/40275934/subject.csv")
interventions <- read_csv("https://figshare.com/ndownloader/files/40279171/interventions.csv") |>
  column_to_rownames("sample")
reads <- read_csv("https://figshare.com/ndownloader/files/40279108/reads.csv") |>
  column_to_rownames("sample")
samples <- read_csv("https://figshare.com/ndownloader/files/40275943/samples.csv")
```

```{r}
ts <- as.matrix(reads) |>
  ts_from_dfs(interventions, samples, subject) |>
  interpolate(method = "linear")
values_df <- pivot_ts(ts)
```

```{r, fig.height = 3, fig.width = 10, eval = FALSE}
top_taxa <- values_df |>
  group_by(taxon) |>
  summarise(mean = mean(value)) |>
  slice_max(mean, n = 7) |>
  pull(taxon)

values_df |>
  group_by(taxon) |>
  mutate(value = rank(value) / n()) |>
  interaction_hm(top_taxa, "diet")
```

### Cross Validation

Here is where we will compare against a few benchmarks.

### Identifying Perturbed Taxa

Here, we'll look at trajectories for a few taxa that are strongly/weakly
affected by the different intervention types. We'll also cluster the shapes of
different predicted trajectories, for a more nuanced view into short/long-term
effects.

```{r}
subject_data(ts) <- subject_data(ts) |>
  mutate(diet = ifelse(diet == "Plant", 0, 1))

fit <- mbtransfer(ts, P = 3, Q = 3)
ts_preds <- list()
ts_missing <- subset_values(ts, 1:8)
ts_preds[["in-sample"]] <- predict(fit, ts_missing)

fit <- mbtransfer(ts[c(1:5, 11:15)], P = 3, Q = 3)
ts_preds[["out-of-sample"]] <- predict(fit, ts_missing[c(6:10, 16:20)])
```

```{r, fig.width = 10, fig.height = 6}
map_dfr(ts_preds, ~ reshape_preds(ts, .), .id = "generalization") |>
    filter(h > 0, h < 6) |>
    ggplot() +
    geom_abline(slope = 1, col = "#400610") +
    geom_point(aes(y, y_hat, col = generalization), size = .7, alpha = .6) +
    facet_grid(factor(quantile, rev(levels(quantile))) ~ glue("lag {h}"), scales = "free_y") +
    labs(x = expression(y), y = expression(hat(y)), col = "Steps Ahead") +
    scale_x_continuous(expand = c(0, 0), n.breaks = 3) +
    scale_y_continuous(expand = c(0, 0), n.breaks = 3) +
    scale_color_manual(values = c("#A65883", "#6593A6")) +
    guides("color" = guide_legend(override.aes = list(size = 4, alpha = 1))) +
    theme(
      axis.text = element_text(size = 10),
      panel.spacing = unit(0, "line"),
      strip.text.y = element_text(angle = 0, size = 12),
      strip.text.x = element_text(angle = 0, size = 12),
      legend.title = element_text(size = 14),
      legend.text = element_text(size = 11),
    )
```

### Inference of Significant Taxa

```{r}
ws <- steps(c("Plant" = TRUE, "Animal" = FALSE), lengths = 1:3, L = 4) |>
  c(steps(c("Plant" = FALSE, "Animal" = TRUE), lengths = 1:3, L = 4))

#staxa <- select_taxa(ts, ws[[1]], ws[[8]],  \(x) mbtransfer(x, 3, 3), n_splits = 20)
#save(staxa, file = "../../data/staxa-diet.rds")
staxa <- readRDS("../../data/staxa-diet.rds")
```

```{r, fig.height = 5, fig.width = 10}
staxa$ms <- staxa$ms |>
  mutate(
    taxon = taxa(ts)[taxon],
    lag = as.factor(lag)
  )

vis_otus <- staxa$ms |>
  group_by(taxon) |>
  summarise(m = mean(m)) |>
  slice_max(m, n = 50) |>
  pull(taxon)

focus_taxa <- unlist(map(staxa$taxa, ~ c(.)))
  
staxa$ms |>
  filter(taxon %in% vis_otus) |>
  mutate(selected = ifelse(taxon %in% focus_taxa, "Selected", "Unselected")) |>
  ggplot() +
  geom_hline(yintercept = 0, size = 2, col = "#d3d3d3") +
  geom_boxplot(aes(reorder(taxon, -m), m, fill = lag, col = lag), alpha = 0.8) +
  facet_grid(. ~ selected, scales = "free_x", space = "free_x") +
  scale_fill_manual(values = c("#c6dbef", "#6baed6", "#2171b5", "#084594")) +
  scale_color_manual(values = c("#c6dbef", "#6baed6", "#2171b5", "#084594")) +
  labs(y = expression(M[j]), x = "Taxon") +
  theme(axis.text.x = element_text(angle = 90, size = 11))
```

* Get m's for the taxa within the selected set X
* Cluster the m's. X
* Fit a model to the full data and simulate differenced trajectories for the selected/clustered taxa X
* Visualize the differenced trajectories, faceted by cluster

```{r}
fit <- mbtransfer(ts, 3, 3)
ws <- steps(c("Plant" = TRUE, "Animal" = FALSE), lengths = 1:3, L = 8) |>
  c(steps(c("Plant" = FALSE, "Animal" = TRUE), lengths = 1:3, L = 8))

sim_ts <- counterfactual_ts(ts, ws[[1]], ws[[8]], start_ix = 4) |>
  map(~ mbtransfer_predict(fit, .))
```

```{r, fig.height = 5, fig.width = 9}
rdata <- ribbon_data(sim_ts[[2]], sim_ts[[1]], focus_taxa)

rdata_wide <- rdata |>
  select(taxon, time, median) |>
  filter(time > 0) |>
  pivot_wider(names_from = time, values_from = median)

rdata_order <- rdata_wide |>
  select(-taxon) %>%
  recipe(~ ., data = .) |>
  step_pca() |>
  prep() |>
  juice() |>
  mutate(taxon = rdata_wide$taxon)
  
rdata |>
  left_join(rdata_order) |>
  ribbon_plot(reorder_var = "1") +
  theme(
    axis.text.y = element_blank(),
    panel.spacing = unit(0, "line")
  )
```

```{r, fig.height = 5, fig.width = 11}
values_df |>
  filter(diet == "Animal") |>
  group_by(taxon) |>
  mutate(value = rank(value) / n()) |>
  interaction_hm(taxa = c("Otu000011", "Otu000017", "Otu000056"), "diet")
```