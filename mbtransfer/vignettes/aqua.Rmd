---
title: "aqua"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{aqua}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(mbtransfer)
library(tidyverse)
```
```{r}
reads <- read_csv("") |>
  column_to_rownames("sample")
samples <- read_csv("") |>
subject_data <- read_csv("")
interventions <- read_csv("") |>
  column_to_rownames("sample")
```


```{r}
ts <- reads |>
  ts_from_dfs(interventions, samples, subject) |>
  interpolate(method = "linear")
```

```{r, eval=F}
ts_missing <- subset_values(ts, 1:8)
fit <- mbtransfer(ts, P = 3, Q = 3)
ts_pred <- predict(fit, ts_missing)
```

```{r}
ws <- steps(c("pH" = TRUE, "AS" = FALSE), lengths = 4, L = 4) |>
  map(~ 2 * . + 5)
ws[[1]]["AS", ] <- 38
ws[[2]]["AS", ] <- 38

staxa <- select_taxa(ts[1:3], ws[[1]], ws[[2]], \(x) mbtransfer(x, 3, 3), n_splits = 20)
save(staxa, file = "../data/staxa-aqua.rds")
#staxa <- readRDS("../data/staxa-diet.rds")
```

Maybe show a gradually increasing trajectory?
or better - several increasing trajectories.

```{r}
fit <- tr_fun(ts)
ws <- steps(c("AS" = TRUE, "pH" = FALSE), lengths = 7, L = 21) |>
  map(~ 20 * . + 20)
ws[[1]]["pH", ] <- 6.2
ws[[2]]["pH", ] <- 6.2

# sim_ts <- counterfactual_ts(ts, ws[[1]], ws[[2]], start_ix = 64) |>
#   map(~ predict(fit, .))
```