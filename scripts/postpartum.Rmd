---
title: "Untitled"
output: html_document
params:
  root_dir: "~/Desktop/collaborations/microbiome_transfer_data/post/data/"
date: "`r Sys.Date()`"
---

```{r}
library(RColorBrewer)
library(fs)
library(tidyverse)
library(mbtransfer)
theme_set(theme_bw())
```

```{r}
root_dir <- path(params$root_dir)
load(root_dir / "data_post.RData")
```

```{r}
post.df <- post.df |>
  filter(PregOut != "Miscarriage", MonVsDel %in% -7:13, LibrarySize >= 4e4) |>
  group_by(SubjID) |>
  filter(max(DayVsDel) > 4, n() > 4)

sample_data <- post.df |>
  rename(sample = SampleID, subject = SubjID, time = DayVsDel)

reads <- post.df |>
  ungroup() |>
  select(SampleID, Lactobacillus:L.other) |>
  column_to_rownames("SampleID")
  
subject_data <- post.df |>
  select(SubjID, HistoryPreterm, Race, Ethnicity, BmiPre, BirthControlYesNo) |>
  ungroup() |>
  mutate(bmi_cut = cut(BmiPre, breaks = quantile(subject_data$BmiPre, seq(0, 1, length.out = 4)))) |>
  rename(subject = SubjID) |>
  group_by(subject) |>
  filter(row_number() == 1)
```

```{r}
interventions <- sample_data |>
  mutate(birth = 1 * (time > -14 & time < 0)) |>
  ungroup() |>
  select(sample, birth) |>
  column_to_rownames("sample")
```

```{r}
#interventions <- 
sample_data |>
  left_join(interventions |> rownames_to_column("sample")) |>
  ggplot() +
  geom_point(aes(time, subject, col = birth))
```

```{r}
ts <- ts_from_dfs(reads, interventions, sample_data, subject_data)
```

```{r}
ts_ <- interpolate(ts, delta = 14, method = "linear")
```

```{r}
plot(values(ts_[[1]])[8, ])
```


```{r}
values_df <- map_dfr(ts_, ~ bind_cols(rownames_to_column(data.frame(t(values(.))), "sample"), time = .@time), .id = "subject") |>
  pivot_longer(Lactobacillus:L.other, names_to = "taxon")
```

```{r}
subject_order <- function(values_df, taxa) {
  values_wide <- values_df |>
    filter(taxon %in% taxa) |>
    select(subject, taxon, value, time) |>
    mutate(time = round(time, -1)) |>
    unite("txtime", taxon, time) |>
    pivot_wider(names_from = txtime) |>
    column_to_rownames("subject") |>
    as.matrix()
  
  values_wide[is.na(values_wide)] <- 0
  rownames(values_wide)[hclust(dist(values_wide))$order]
}

interaction_hm <- function(values_df, subject_data, taxa, condition) {
  values_df |>
    filter(taxon %in% taxa) |>
    left_join(subject_data) |>
    mutate(subject = factor(subject, subject_order(values_df, taxa))) |>
    ggplot() +
    geom_tile(aes(time, subject, fill = value, col = value), width = 14) +
    scale_x_continuous(expand = c(0, 0)) +
    facet_grid(.data[[condition]] ~ reorder(taxon, -value), scales = "free", space = "free") +
    scale_fill_distiller(direction = 1) +
    scale_color_distiller(direction = 1) +
    theme(
      strip.text.y = element_text(angle = 0),
      panel.grid = element_blank(),
      panel.border = element_rect(linewidth = 1, fill = NA, color = "#545454"),
      panel.spacing = unit(0, "cm")
    )
}
```


```{r}
taxa <- c("L.gasseri", "Lactobacillus", "Gardnerella")
interaction_hm(values_df, subject_data, taxa, "Race")
interaction_hm(values_df, subject_data, taxa, "BirthControlYesNo")
interaction_hm(values_df, subject_data, taxa, "bmi_cut")
```

```{r}
interaction_barcode <- function(values_df, subject_data, taxa, condition) {
  values_df |>
    filter(taxon %in% taxa) |>
    left_join(subject_data) |>
    mutate(subject = factor(subject, levels = subject_order(values_df, taxa))) |>
    ggplot() +
    geom_tile(aes(time, taxon, fill = value, col = value), width = 14) +
    scale_x_continuous(expand = c(0, 0)) +
    facet_nested(reorder(.data[[condition]], -value) + subject ~ ., scales = "free", space = "free") +
    scale_fill_distiller(direction = 1) +
    scale_color_distiller(direction = 1) +
    theme(
      panel.spacing = unit(0, "line"),
      panel.border = element_rect(linewidth = 1, fill = NA, color = "#d3d3d3"),
      strip.text.y = element_text(angle = 0),
      panel.grid = element_blank(),
      axis.text.y = element_blank(),
      axis.ticks.y = element_blank()
    )
}
```

```{r, fig.height = 12, fig.width = 6}
interaction_barcode(values_df, subject_data, taxa, "Race")
interaction_barcode(values_df, subject_data, taxa, "BirthControlYesNo")
interaction_barcode(values_df, subject_data, taxa, "bmi_cut")
```



