---
title: "Untitled"
output: html_document
params:
  root_dir: "~/Desktop/collaborations/microbiome_transfer_data/post/data/"
date: "`r Sys.Date()`"
---

```{r}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

```{r}
library(RColorBrewer)
library(ggh4x)
library(fs)
library(tidyverse)
library(mbtransfer)
library(tfPaper)
theme_set(my_theme())
```

```{r}
root_dir <- path(params$root_dir)
load(root_dir / "data_post.RData")
```

```{r}
post.df <- post.df |>
  filter(PregOut != "Miscarriage", MonVsDel %in% -7:13, LibrarySize >= 4e4) |>
  group_by(SubjID) |>
  filter(max(DayVsDel) > 4, n() > 4)

sample_data <- post.df |>
  rename(sample = SampleID, subject = SubjID, time = DayVsDel)

reads <- post.df |>
  ungroup() |>
  select(SampleID, Lactobacillus:L.other) |>
  column_to_rownames("SampleID")
  
subject_data <- post.df |>
  select(SubjID, HistoryPreterm, Race, Ethnicity, BmiPre, BirthControlYesNo) |>
  ungroup() |>
  mutate(bmi_cut = cut(BmiPre, breaks = quantile(BmiPre, seq(0, 1, length.out = 4)))) |>
  rename(subject = SubjID) |>
  group_by(subject) |>
  filter(row_number() == 1)
```

```{r}
interventions <- sample_data |>
  mutate(birth = 1 * (time > -14 & time < 0)) |>
  ungroup() |>
  select(sample, birth) |>
  column_to_rownames("sample")
```

```{r}
sample_data |>
  left_join(interventions |> rownames_to_column("sample")) |>
  ggplot() +
  geom_point(aes(time, subject, col = birth))
```

```{r}
ts <- ts_from_dfs(reads, interventions, sample_data, subject_data)
ts_ <- interpolate(ts, delta = 14, method = "linear")
```

```{r}
values_df <- pivot_ts(ts_)

taxa <- c("L.gasseri", "Lactobacillus", "Gardnerella")
interaction_hm(values_df, taxa, "Race", -1)
interaction_hm(values_df, taxa, "BirthControlYesNo", -1)
interaction_hm(values_df, taxa, "bmi_cut", -1)
```

```{r, fig.height = 12, fig.width = 6}
interaction_barcode(values_df, taxa, "Race")
interaction_barcode(values_df, taxa, "BirthControlYesNo")
interaction_barcode(values_df, taxa, "bmi_cut")
```
