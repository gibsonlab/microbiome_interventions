---
title: "Untitled"
output: html_document
params:
  root_dir: "~/Desktop/collaborations/microbiome_transfer_data/post/data/"
date: "`r Sys.Date()`"
---

```{r}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

```{r}
library(fs)
library(tidyverse)
library(mbtransfer)
library(glue)
library(tfPaper)
theme_set(my_theme())
```

r````{r}
ts <- reads |>
 normalize("DESeq2-asinh", metadata) |>
 ts_from_dfs(interventions, samples, subject_data) |>
 interpolate(delta = 14, method = "linear")
```

```{r, fig.height = 12, fig.width = 6}
interaction_barcode(values_df, taxa, "BirthControlYesNo", width = 14)
interaction_barcode(values_df, taxa, "bmi_cut", width = 14)
```

```{r}
tr_fun <- function(x) {
  mbtransfer(x, P = 3, Q = 3)
}

subject_data(ts) <- subject_data(ts) |>
  select(subject, BirthControlYesNo) |>
  mutate(
    BCYes = 1 * (BirthControlYesNo == "Yes"),
    BCNo = 1 * (BirthControlYesNo == "No")
  ) |>
  select(subject, starts_with("BC"))

fit <- tr_fun(ts)
```

## Smoothing and Out-of-Sample Performance

```{r}
ts_missing <- subset_values(ts, 1:8)
fit <- mbtransfer(ts, P = 3, Q = 3)
ts_pred <- predict(fit, ts_missing)
```

```{r}
#fit <- mbtransfer(ts[c(1:5, 11:15)], P = 3, Q = 3) # uncomment for out-of-sample error
#ts_pred <- predict(fit, ts_missing[c(6:10, 16:20)])
```

```{r}
ts_df <- pivot_ts(ts_pred) |>
  rename(y_hat = value) |>
  select(taxon, sample, time, y_hat) |>
  mutate(h = time - 2) |>
  left_join(pivot_ts(ts)) |>
  rename(y = value) |>
  filter(y != y_hat)
```

```{r, fig.width = 10, fig.height = 6}
common_taxa <- ts_df |>
  group_by(taxon) |>
  summarise(mean_y = mean(y)) |>
  slice_max(mean_y, n = 18) |>
  pull(taxon)

ts_df |>
  filter(taxon %in% common_taxa, h < 6) |>
  ggplot() +
  geom_abline(slope = 1, col = "#400610") +
  geom_point(aes(y, y_hat, col = factor(h)), size = 1.5, alpha = 1) +
  scale_color_brewer(palette = "reds", direction = -1) +
  facet_wrap(~ reorder(taxon, -y), scales = "free", ncol = 6) +
  labs(x = expression(y), y = expression(hat(y)), col = "steps ahead") +
  theme(
    axis.text = element_text(size = 10),
    panel.spacing = unit(0, "line")
  )

#ggsave("~/Downloads/postpartum_forecast_error.png", width = 10, height = 6)
```


```{r}
ws <- steps(c("birth" = TRUE), lengths = 2:4, L = 4)
staxa <- select_taxa(ts, ws[[1]], ws[[2]], tr_fun, n_splits = 20)
```

```{r, fig.height = 10, fig.width = 8}
staxa$ms |>
  mutate(
    taxon = taxa(ts)[taxon],
    lag = as.factor(lag),
    selected = ifelse(taxon %in% unlist(staxa$taxa), "Selected", "Not Selected")
  ) |>
  ggplot() +
  geom_hline(yintercept = 0, size = 2, col = "#d3d3d3") +
  geom_boxplot(aes(reorder(taxon, -m), m, fill = lag, col = lag), alpha = 0.8) +
  facet_grid(. ~ selected, scales = "free_x", space = "free_x") +
  scale_fill_manual(values = c("#c6dbef", "#6baed6", "#2171b5", "#084594")) +
  scale_color_manual(values = c("#c6dbef", "#6baed6", "#2171b5", "#084594")) +
  labs(y = expression(M[j]), x = "Taxon") +
  theme(axis.text.x = element_text(angle = 90, size = 11))

#ggsave("~/Downloads/postpartum-mirror.png", height = 5, width = 10)
```

```{r}
ws <- steps(c("birth" = TRUE), lengths = 2, L = 10)
start_ix <- map_dbl(ts, ~ min(which(.@time >= -14))) - 1

sim_bc <- list()
for (i in 0:1) {
  bc <- subject_data(ts) |>
    mutate(BCYes = rep(i, n()), BCNo = rep(1 - i, n()))
  sim_bc[[i + 1]] <- counterfactual_ts(ts, ws[[1]], ws[[2]], start_ix) |>
    map(~ replace_subject(., bc)) |>
    map(~ predict(fit, .))
}
```

```{r}
focus_taxa <- c("Porphyromonas", "Lactobacillus", "Prevotella_6", "L.gasseri", "L.iners", "Atopobium")
rdata <- sim_bc |>
  map_dfr(~ ribbon_data(.[[2]], .[[1]], focus_taxa, delta =  7), .id = "BC") |>
  mutate(
    BC = fct_recode(BC, No = "1", Yes = "2")
    ) |>
  filter(time > -25, time < 80)

pal <- c("#F2785C", "#144673")
ribbon_plot(rdata, group = "BC") +
  facet_wrap(~ reorder(taxon, median)) +
  labs(y = expression(paste(Delta, " Abundance")), x = "Day", fill = "Birth Control Reinitiated", col = "Birth Control Reinitiated") +
  scale_color_manual(values = pal) +
  scale_fill_manual(values = pal) +
  theme(
    axis.title = element_text(size = 12), 
    strip.text = element_text(size = 12)
  )

#ggsave("~/Desktop/laboratory/talks/2023/20230414/figures/counterfactual_postpartum_staxa.png", width = 9, height = 4.5)
```

```{r}
ts_missing <- subset_values(ts, 1:6)
ts_hat <- predict(fit, ts_missing)
subject_errors <- map_dfr(ts_hat - ts, ~ tibble(mse = mean(abs(values(.)))), .id = "subject")
```

```{r, fig.height = 6, fig.width = 10}
quantiles <- quantile(subject_errors$mse, c(0.1, 0.9))
values_df |>
  left_join(subject_errors) |>
  filter(taxon %in% focus_taxa, mse > quantiles[2] | mse < quantiles[1]) |>
  mutate(
    low_error = ifelse(mse < quantiles[1], "Small Residual", "Large Residual"),
    low_error = factor(low_error, levels = c("Small Residual", "Large Residual")),
    taxon = factor(taxon, levels = focus_taxa)
    ) |>
  ggplot() +
  geom_vline(xintercept = 0, col = "#d3d3d3", size = 2) +
  geom_line(aes(time, value, group = subject), alpha = 0.7, size = 0.4) +
  facet_grid(reorder(taxon, -value) ~ low_error, scales = "free") +
  scale_x_continuous(expand = c(0, 0)) +
  labs(y = "Abundance") +
  theme(
    strip.text.y = element_text(angle = 0, size = 12),
    strip.text.x = element_text(size = 12),
    axis.text = element_text(size = 8)
  )
#ggsave("~/Desktop/laboratory/talks/2023/20230414/figures/residual_postpartum.png", width = 10, height = 6)
```

```{r, fig.width = 10, fig.height = 5}
values_df <- pivot_ts(ts) |>
  group_by(taxon) |>
  mutate(value = rank(value) / n()) |>
  left_join(subject_data)

vis_taxa <- c("Lactobacillus", "L.iners", "Porphyromonas", "Prevotella_6")
interaction_hm(values_df, vis_taxa, "BirthControlYesNo", -1, width = 14) +
  theme(
    axis.text.y = element_blank(),
    strip.text = element_text(size = 12)
  )
ggsave("~/Downloads/cover.png", dpi = 1000, width = 10, height = 4)
#ggsave("~/Desktop/laboratory/talks/2023/20230414/figures/progressive_disclosure_postpartum.png", width = 10, height = 4.5)
```