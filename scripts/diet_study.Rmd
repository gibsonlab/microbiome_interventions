---
title: "Untitled"
output: html_document
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE)
```

```{r}
library(tfPaper)
library(mbtransfer)
library(tidyverse)
library(fs)
library(tidymodels)
theme_set(my_theme())
```

```{r}
data_dir <- path("../../microbiome_transfer_data/david")
reads <- read_csv(data_dir / "abundance.csv") |>
  rename(sample = `...1`) |>
  column_to_rownames("sample") |>
  as.matrix()
samples <- read_csv(data_dir / "sample_metadata.csv", col_names = c("sample", "subject", "time")) |>
  mutate(intervention = str_extract(subject, "[A-z]+"))
subject <- read_csv(data_dir / "subject_data.csv")

keep_ix <- colMeans(reads != 0) > 0.4
reads <- reads[, as.logical(keep_ix)]
```

```{r}
taxonomy <- read_csv("https://raw.githubusercontent.com/gerberlab/mitre/master/mitre/example_data/david/taxaTable.csv") |>
  mutate(
    name = str_c("Otu", str_pad(tax_id, 6, "left", "0")),
    sequence = NA,
  ) |>
  filter(name %in% colnames(reads)) |>
  rename(kingdom = superkingdom)
taxa_names <- colnames(reads)
new_ix <- !(taxa_names %in% taxonomy$name)
taxonomy <- taxonomy |>
  bind_rows(data.frame(name = taxa_names[new_ix]))
```


```{r}
interventions <- samples |>
  select(time, intervention, sample) |>
  mutate(value = 1) |>
  pivot_wider(names_from = intervention, values_fill = 0) |>
  column_to_rownames("sample") |>
  mutate(
    perturbation_window = time >= 0 & time <= 5,
    Animal = ifelse(perturbation_window & Animal == 1, 1, 0),
    Plant = ifelse(perturbation_window & Plant == 1, 1, 0)
  ) |>
  select(Plant, Animal)

subject <- subject |>
  rename(subject = subject_ID)
samples <- samples |>
  rename(condition = intervention)
```

```{r}
ts <- reads |>
  normalize("DESeq2-asinh", samples) |>
  ts_from_dfs(interventions, samples, subject) |>
  interpolate(method = "linear")
values_df <- pivot_ts(ts)
```

```{r, fig.height = 3, fig.width = 10, eval = FALSE}
top_taxa <- values_df |>
  group_by(taxon) |>
  summarise(mean = mean(value)) |>
  slice_max(mean, n = 7) |>
  pull(taxon)

values_df |>
  group_by(taxon) |>
  mutate(value = rank(value) / n()) |>
  interaction_hm(top_taxa, "diet")
```

### Cross Validation

Here is where we will compare against a few benchmarks.

### Identifying Perturbed Taxa

Here, we'll look at trajectories for a few taxa that are strongly/weakly
affected by the different intervention types. We'll also cluster the shapes of
different predicted trajectories, for a more nuanced view into short/long-term
effects.

```{r}
subject_data(ts) <- subject_data(ts) |>
  mutate(diet = ifelse(diet == "Plant", 0, 1))

ts_missing <- subset_values(ts, 1:8)
fit <- mbtransfer(ts, P = 3, Q = 3)
ts_pred <- predict(fit, ts_missing)
```

```{r}
fit <- mbtransfer(ts[c(1:5, 11:15)], P = 3, Q = 3) # uncomment for out-of-sample error
ts_pred <- predict(fit, ts_missing[c(6:10, 16:20)])
```

```{r}
ts_df <- pivot_ts(ts_pred) |>
  rename(y_hat = value) |>
  select(taxon, sample, time, y_hat) |>
  mutate(h = time - 2) |>
  left_join(pivot_ts(ts)) |>
  rename(y = value) |>
  filter(y != y_hat)
```

```{r, fig.width = 10, fig.height = 6}
common_taxa <- ts_df |>
  group_by(taxon) |>
  summarise(mean_y = mean(y)) |>
  slice_max(mean_y, n = 18) |>
  pull(taxon)

ts_df |>
  filter(taxon %in% common_taxa, h < 6) |>
  ggplot() +
  geom_abline(slope = 1, col = "#400610") +
  geom_point(aes(y, y_hat, col = factor(h)), size = 1.5, alpha = 1) +
  scale_color_brewer(palette = "Reds", direction = -1) +
  facet_wrap(~ reorder(taxon, -y), scales = "free", ncol = 6) +
  labs(x = expression(y), y = expression(hat(y)), col = "Steps Ahead") +
  theme(
    axis.text = element_text(size = 10),
    panel.spacing = unit(0, "line")
  )

#ggsave("~/Downloads/diet_forecast_error.png", width = 10, height = 6)
```

### Inference of Significant Taxa

```{r}
ws <- steps(c("Plant" = TRUE, "Animal" = FALSE), lengths = 1:3, L = 4) |>
  c(steps(c("Plant" = FALSE, "Animal" = TRUE), lengths = 1:3, L = 4))

tr_fun <- function(x) {
  mbtransfer(x, P = 3, Q = 3, verbose = FALSE)
}

staxa <- select_taxa(ts, ws[[1]], ws[[8]], tr_fun, n_splits = 20)
#staxa <- readRDS("../data/staxa-diet.rds")
```

```{r, fig.height = 5, fig.width = 10}
staxa$ms <- staxa$ms |>
  mutate(
    taxon = taxa(ts)[taxon],
    lag = as.factor(lag)
  )

vis_otus <- staxa$ms |>
  group_by(taxon) |>
  summarise(m = mean(m)) |>
  slice_max(m, n = 50) |>
  pull(taxon)

focus_taxa <- unlist(map(staxa$taxa, ~ c(.)))
  
staxa$ms |>
  filter(taxon %in% vis_otus) |>
  mutate(selected = ifelse(taxon %in% focus_taxa, "Selected", "Unselected")) |>
  ggplot() +
  geom_hline(yintercept = 0, size = 2, col = "#d3d3d3") +
  geom_boxplot(aes(reorder(taxon, -m), m, fill = lag, col = lag), alpha = 0.8) +
  facet_grid(. ~ selected, scales = "free_x", space = "free_x") +
  scale_fill_manual(values = c("#c6dbef", "#6baed6", "#2171b5", "#084594")) +
  scale_color_manual(values = c("#c6dbef", "#6baed6", "#2171b5", "#084594")) +
  labs(y = expression(M[j]), x = "Taxon") +
  theme(axis.text.x = element_text(angle = 90, size = 11))

#ggsave("~/Desktop/laboratory/talks/2023/20230414/figures/diet-mirror.png", height = 5, width = 10)
```

* Get m's for the taxa within the selected set X
* Cluster the m's. X
* Fit a model to the full data and simulate differenced trajectories for the selected/clustered taxa X
* Visualize the differenced trajectories, faceted by cluster

```{r}
fit <- tr_fun(ts)
ws <- steps(c("Plant" = TRUE, "Animal" = FALSE), lengths = 1:3, L = 8) |>
  c(steps(c("Plant" = FALSE, "Animal" = TRUE), lengths = 1:3, L = 8))

sim_ts <- counterfactual_ts(ts, ws[[1]], ws[[8]], start_ix = 4) |>
  map(~ mbtransfer_predict(fit, .))
```

```{r, fig.height = 5, fig.width = 9}
rdata <- ribbon_data(sim_ts[[2]], sim_ts[[1]], focus_taxa)

rdata_wide <- rdata |>
  select(taxon, time, median) |>
  filter(time > 0) |>
  pivot_wider(names_from = time, values_from = median)

rdata_order <- rdata_wide |>
  select(-taxon) %>%
  recipe(~ ., data = .) |>
  step_pca() |>
  prep() |>
  juice() |>
  mutate(taxon = rdata_wide$taxon)
  
rdata |>
  left_join(rdata_order) |>
  ribbon_plot(reorder_var = "1") +
  theme(
    axis.text.y = element_blank(),
    panel.spacing = unit(0, "line")
  )

#ggsave("~/Desktop/laboratory/talks/2023/20230414/figures/counterfactual_diet_staxa.png", height = 5, width = 9)
```

```{r, fig.height = 5, fig.width = 11}
values_df |>
  filter(diet == "Animal") |>
  group_by(taxon) |>
  mutate(value = rank(value) / n()) |>
  interaction_hm(taxa = c("Otu000011", "Otu000017", "Otu000056"), "diet")
ggsave("~/Desktop/laboratory/talks/2023/20230414/figures/progressive_disclosure_diet.png", height = 5, width = 11)
```
