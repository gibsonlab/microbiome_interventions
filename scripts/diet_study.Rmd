---
title: "Untitled"
output: html_document
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```
```{r}
library(microTF)
library(tidyverse)
library(fs)
theme_set(theme_bw())
```

### Data Preprocessing

```{r}
data_dir <- path("../../microbiome_transfer_data/david")
abundances <- read_csv(data_dir / "abundance.csv") %>%
  rename(sample = `...1`)
samples <- read_csv(data_dir / "sample_metadata.csv", col_names = c("sample", "subject", "time")) %>%
  mutate(intervention = str_extract(subject, "[A-z]+"))
subject <- read_csv(data_dir / "subject_data.csv")
keep_ix <- colMeans(as.matrix(abundances[, -1]) != 0) > 0.2
reads <- abundances[, c(TRUE, keep_ix)] %>%
  column_to_rownames("sample") %>%
  .[, 1:50]
```


```{r}
interventions <- samples %>%
  select(time, intervention, sample) %>%
  mutate(value = 1) %>%
  pivot_wider(names_from = intervention, values_fill = 0) %>%
  column_to_rownames("sample") %>%
  mutate(
    perturbation_window = time >= 0 & time <= 5,
    Animal = ifelse(perturbation_window & Animal == 1, 1, 0),
    Plant = ifelse(perturbation_window & Plant == 1, 1, 0) 
  ) %>%
  select(Plant, Animal)


ts_inter <- ts_from_dfs(reads, interventions, samples)
```

```{r}
values(ts_inter[[1]])
interventions(ts_inter[[1]])
ts_inter[[1]]@time
```

```{r}
ts <- interpolate(ts_inter)

i <- 6; j <- 10
plot(ts[[i]]@time, values(ts[[i]])[j, ], col = "red")
points(ts_inter[[i]]@time, values(ts_inter[[i]])[j, ])
```

### Cross Validation

```{r, eval = FALSE}
fit <- train(ts, method = "gbm")
train_data <- patchify_df(ts, p = 1, q = 4)
y_hat <- predict(fit@parameters[[1]], train_data$x)
plot(train_data$y[[1]], y_hat)
abline(a = 0, b = 1, col = "red")
```

```{r, eval = FALSE}
new_interventions <- matrix(c(0, 0, 0, 1, 1, 0, 0, 0, 0, 0), nrow = 2)
y_hat <- gbm_predict_(fit@parameters, ts[1:2], new_interventions)
plot(values(y_hat[[2]])[j, ])
```

### MDSINE

```{r}
taxonomy <- read_tsv("md_data/taxonomy.tsv")
hyper <- list(taxonomy = taxonomy[1:50, ])
fit <- train(ts, "mdsine", hyper)
```

