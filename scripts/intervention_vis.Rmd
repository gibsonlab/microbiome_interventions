---
title: "Untitled"
output: html_document
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

```{r}
library(microTF)
library(tidyverse)
library(fs)
theme_set(theme_bw())
reticulate::use_condaenv("~/miniforge-pypy3/envs/mdsine2/")
cols <- c("#466C8C", "#F28705")
```


```{r}
ts_inter_df <- function(ts_inter) {
    tibble(
      time = ts_inter@time, 
      first_inter = min(which(colSums(interventions(ts_inter)) > 0)),
      rel_time = time - time[first_inter]
    ) %>%
    bind_cols(t(values(ts_inter))) %>%
    bind_cols(t(interventions(ts_inter)))
}

ts_to_df <- function(ts) {
  map_dfr(ts,  ~ ts_inter_df(.), .id = "subject") %>%
    mutate(
      subject = str_c("S", subject),
      rel_time = ifelse(is.na(rel_time), time, rel_time)
      ) %>%
    select(-first_inter)
}

intervention_plot <- function(ts_df, taxon = "Otu000001") {
  ts_df <- ts_df %>%
    rename(value = .data[[taxon]])
  
  ggplot(ts_df, aes(rel_time, reorder(subject, value))) +
    geom_tile(aes(fill = value)) +
    geom_point(data = ts_df %>% filter(Animal == 1), shape = 1) +
    scale_fill_distiller(direction = 1) +
    labs(title = tax_ix)
}
```

### Data Preprocessing

```{r}
data_dir <- path("../../microbiome_transfer_data/david")
abundances <- read_csv(data_dir / "abundance.csv") %>%
  rename(sample = `...1`)
samples <- read_csv(data_dir / "sample_metadata.csv", col_names = c("sample", "subject", "time")) %>%
  mutate(intervention = str_extract(subject, "[A-z]+"))
subject <- read_csv(data_dir / "subject_data.csv")
keep_ix <- colMeans(as.matrix(abundances[, -1]) != 0) > 0.2
reads <- abundances[, c(TRUE, keep_ix)] %>%
  column_to_rownames("sample") %>%
  .[, 1:25] %>%
  asinh()
```


```{r}
interventions <- samples %>%
  select(time, intervention, sample) %>%
  mutate(value = 1) %>%
  pivot_wider(names_from = intervention, values_fill = 0) %>%
  column_to_rownames("sample") %>%
  mutate(
    perturbation_window = time >= 0 & time <= 5,
    Animal = ifelse(perturbation_window & Animal == 1, 1, 0),
    Plant = ifelse(perturbation_window & Plant == 1, 1, 0) 
  ) %>%
  select(Plant, Animal)

ts <- ts_from_dfs(reads, interventions, samples) %>%
  interpolate()
```

### Original trajectories

We first visualize some of the original trajectories.

```{r}
taxa <- rownames(values(ts[[1]]))
p <- list()
for (tax_ix in seq_along(taxa[1:25])) {
  p[[tax_ix]] <- intervention_plot(ts_to_df(ts), taxa[tax_ix])
} 
```

```{r}
p[[5]]
p[[11]]
p[[17]]
```

### Visualizing Counterfactuals

Next, let's visualize the counterfacutal where we assume everyone was / was not
given the intervention. For this proof of concept, we're not going to bother
splitting the data into train / test groups.

```{r}
fit <- train(ts, "gbm")
```

We will mask all the timepoints before the first intervention, and we will
manipulate the interventions manually.

```{r}
ts0 <- ts
ts1 <- ts

for (i in seq_along(ts)) {
  inter <- interventions(ts[[i]])
  init_ix <- min(which(colSums(inter) > 0))
  v <- values(ts[[i]])[, seq_len(init_ix - 1)]
  
  values(ts0[[i]]) <- v
  values(ts1[[i]]) <- v
  
  inter[, seq(init_ix, ncol(inter))] <- 0
  interventions(ts0[[i]]) <- inter
  
  inter["Animal", seq(init_ix, init_ix + 3)] <- 1
  interventions(ts1[[i]]) <- inter
}

ts0 <- predict(fit, ts0)
ts1 <- predict(fit, ts1)

```


```{r}
tax_ix <- 17
ts1_df <- ts_to_df(ts1)
ggplot(ts1_df) +
  geom_histogram(aes(.data[[taxa[tax_ix]]], fill = as.factor(Animal)), position = "identity", alpha = 0.8) +
  scale_fill_brewer(palette = "Set1")

intervention_plot(ts1_df, taxa[tax_ix])
```

Here is the same plot under the counterfactual that no one was intervened upon.

```{r}
ts0_df <- ts_to_df(ts0)
ggplot(ts0_df) +
  geom_histogram(aes(.data[[taxa[tax_ix]]], fill = as.factor(Animal)), position = "identity", alpha = 0.8) +
  scale_fill_brewer(palette = "Set1")
intervention_plot(ts0_df, taxa[tax_ix])
```

We can plot the differences too.

```{r}
ts1_df_ <- ts1_df %>%
  pivot_longer(starts_with("Otu"), names_to = "taxon")

ts0_df_ <- ts0_df %>%
  pivot_longer(starts_with("Otu"), names_to = "taxon")
  
ts_counter <- ts1_df_ %>%
  rename(value1 = value) %>%
  select(-Animal, -Plant) %>%
  left_join(ts0_df_ %>% rename(value0 = value) %>% select(-rel_time))
```

There is some evidence of a delayed effect.

```{r}
ts_counter %>%
  filter(taxon == taxa[17]) %>%
  ggplot() +
  geom_tile(aes(rel_time, reorder(subject, abs(value1 - value0)), fill = value1 - value0)) +
  scale_fill_gradient2()
```

Let's make the analogous figure for a taxon that we think have negative /
neutral effects.

```{r}
ts_counter %>%
  filter(taxon == taxa[11]) %>%
  ggplot() +
  geom_tile(aes(rel_time, reorder(subject, abs(value1 - value0)), fill = value1 - value0)) +
  scale_fill_gradient2()

ts_counter %>%
  filter(taxon == taxa[5]) %>%
  ggplot() +
  geom_tile(aes(rel_time, reorder(subject, abs(value1 - value0)), fill = value1 - value0)) +
  scale_fill_gradient2()
```

Note that training performance is sensitive to the transformation we gave. We
are not looking into the full confidence band of each series, but this could be
of potential interest.

This figure is optimistic, because we haven't split the training and impulse
function visualization. As a summary, it is okay to look at the full data. But
as soon as we want to have some population level guarantee on the difference
between counterfactual transfer functions, this will not be sufficient. Though,
perhaps we can frame this is the analog of variable importance in the transfer
function setting.

I would like to show this on the same time scale (i.e., relative to min
intervention time, so they are more aligned). It would be useful to automate the
calculation of the difference (put it in a package function) and show it as a
simplified line plot across a collection of taxa.

Finally, we want to be able to learn variations of the function across
populations.


### Line Summaries

```{r}
bind_rows(
  mutate(ts1_df_, counterfactual = "1"),
  mutate(ts0_df_, counterfactual = "0")
) %>%
  group_by(rel_time, taxon, counterfactual) %>%
  summarise(
    mean = mean(value),
    upper = mean + 1.9 * sd(value),
    lower = mean - 1.9 * sd(value)
    ) %>%
  filter(taxon %in% taxa[c(5, 11, 17)])  %>%
  ggplot(aes(rel_time, col = counterfactual)) +
  geom_ribbon(
    aes(
      rel_time, 
      ymin = lower, 
      ymax = upper, 
      fill = counterfactual
      ),
    alpha = 0.1,
    size = 0.1
  ) +
  geom_line(aes(y = mean), size = 1) +
  xlim(-5, 10) +
  scale_fill_manual(values = cols) +
  scale_color_manual(values = cols) +
  facet_wrap(~ taxon)
```
