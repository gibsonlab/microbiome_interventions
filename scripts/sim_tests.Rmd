---
title: "simulation"
output: pagedown::book_crc
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

```{r}
library(microTF)
library(tidyverse)
library(phyloseq)
library(DESeq2)
source("../microTF/R/simulate_dynamics.R")
theme_set(theme_bw())
set.seed(20230313)
```

This generates the coefficient matrices for dynamics, perturbations, and
interactions.

```{r}
n_lag <- 5
n_taxa <- 500
n_perturb <- 1
n_latent <- 5
n_covariates <- 3
prop_nonnull <- 0.1

A <- low_rank_step(n_taxa, n_latent, n_taxa, n_lag) %>%
 sparsify() %>%
 normalize(0.8)
B <- low_rank_step(n_taxa, n_latent, n_perturb, n_lag, sigma = 0.5)
  #normalize(10)

nonnull_taxa <- sample(n_taxa, prop_nonnull * n_taxa)
for (i in seq_along(B)) {
  B[[i]][-nonnull_taxa, ] <- 0
}

C <- low_rank_step_(n_taxa, n_latent, n_perturb, n_lag)
for (i in seq_along(C)) {
  C[[i]] <- C[[i]] %>%
    sparsify() %>%
    normalize(0.2)
}
```

Now we can simulate one example series.

For negative binomial simulation, remember that if the variance is $\mu$, the
variance is $\mu + \frac{1}{\text{size}}\mu^2$, where $\text{size}$ is the
number of successes before we stop.

```{r}
step_generator <- step_t(linear_sum(A), linear_sum(B), interaction_sum(C))
x0 <- matrix(2, n_taxa, n_lag + 1)
w <- matrix(0, n_perturb, 30)
w[, 15:20] <- 1
z <- rnorm(n_covariates)
sizes <- runif(n_taxa, .1, 10)
baselines <- rgamma(n_taxa, 1, .1)
x <- generate_sample(x0, w, z, step_generator, nbinom_sampler(sizes, baselines))
```

Next, we can plot the series.

```{r}
rownames(x) <- str_c("tax", seq_len(nrow(x)))
x_df <- data.frame(x) %>%
  rownames_to_column("taxon") %>%
  pivot_longer(-taxon, names_to = "time") %>%
  mutate(time = as.integer(str_remove(time, "X")))  %>%
  filter(time  > n_lag)

B_df <- map_dfr(
  B, ~ as_tibble(.) %>% 
    mutate(taxon = str_c("tax", row_number())),
  .id = "lag") %>%
  pivot_wider(names_from = "lag", values_from = "V1")

x_df <- x_df %>%
  left_join(B_df) %>%
  mutate(effect = rowSums(.[, -c(1:3)]))
  
x_df %>%
  filter(effect != 0) %>%
  ggplot() +
  geom_rect(xmin = 15, xmax = 20, ymin = 0, ymax = max(x_df$value), fill = "#d3d3d3") +
  geom_line(aes(time, value, col = effect)) +
  facet_wrap(~ reorder(taxon, effect), ncol = 10) +
  scale_y_log10() +
  scale_color_gradient2(mid = "#d3d3d3")
```

If we were using DESeq2, how would we test?

```{r}
metadata <- tibble(
  time = seq(n_lag + 1, ncol(x)),
  perturbation = ifelse(time >= 15 & time <= 20, 1, 0)
)

ps <- phyloseq(
  otu_table(x[, -seq_len(n_lag)], taxa_are_rows = TRUE),
  sample_data(metadata)
)

dds  <- phyloseq_to_deseq2(ps, ~ perturbation)
dds <- DESeq(dds)
```

```{r}
significant <- results(dds) %>%
  data.frame() %>%
  rownames_to_column("taxon") %>%
  filter(padj < 0.2)

significant %>%
  arrange(padj)
```

These are the taxa that DESeq2 thinks are significant.

```{r}
x_df %>%
  filter(taxon %in% significant$taxon) %>%
  ggplot() +
  geom_rect(xmin = 15, xmax = 20, ymin = 0, ymax = max(x_df$value), fill = "#d3d3d3") +
  geom_line(aes(time, value, col = effect)) +
  facet_wrap(~ reorder(taxon, effect)) +
  scale_y_log10() +
  scale_color_gradient2(mid = "#d3d3d3")
```

```{r}
nonnull_taxa_ <- str_c("tax", nonnull_taxa)

R <- significant$taxon
S <- intersect(nonnull_taxa_,  significant$taxon)
V <- setdiff(significant$taxon, nonnull_taxa_)
```

At a $q$-level of 0.2, the FDP is `r length(V) / length(R)`. The power is `r
length(S) / length(significant$taxon)`.