---
title: "Dynamical System Simulation"
output: 
  html_document:
    highlight: "kate"
date: "`r Sys.Date()`"
params:
  run_id: 2
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```
```{r}
library(stringr)
library(glue)
library(tidygraph)
library(tidyverse)
library(tfPaper)
set.seed(params$replicate)
```

```{r}
fixed_parameters <- list(
  n_perturb = 1, 
  n_covariates = 3, 
  n_latent = 2, 
  normalizer_A = 0.8, 
  normalizer_C = 0.8
)

varying_parameters <- expand.grid(
  n_subject = c(20, 40),
  n_time = c(15, 30),
  n_lag = c(2, 4),
  n_taxa = c(100, 250),
  prop_nonnull = c(0.05, 0.2),
  sparsity_A = c(0.2, 0.8),
  signal_B = c(0.5, 1, 2),
  replicate = seq_len(4)
) |>
  mutate(output_path = glue("~/Downloads/sim_input_{str_pad(row_number(), 3, 'left', '0')}.rda"))

attach(fixed_parameters)
attach(as.list(varying_parameters[params$run, ]))
```

```{r}
nonnull_taxa <- seq(n_taxa * prop_nonnull)
```

This generates the coefficient matrices for dynamics, perturbations, and
interactions.

```{r}
A <- low_rank_step(n_taxa, n_latent, n_taxa, n_lag) |>
 sparsify(sparsity_A) |>
 normalize_mat(normalizer_A)
B <- low_rank_step(n_taxa, n_latent, n_perturb, n_lag, lower = -signal_B, upper = signal_B) |>
  sparsify_rows(nonnull_taxa)
C <- low_rank_step_(n_taxa, n_latent, n_perturb, n_lag) |>
  map(~ sparsify(.) |> normalize_mat(normalizer_C))
```

Now we can simulate one example series.

For negative binomial simulation, remember that if the variance is $\mu$, the
variance is $\mu + \frac{1}{\text{size}}\mu^2$, where $\text{size}$ is the
number of successes before we stop.

```{r}
step_generator <- step_t(linear_sum(A), linear_sum(B), interaction_sum(C))
theta0 <- matrix(2, n_taxa, n_lag + 1)
w <- random_interventions(n_perturb, n_time, n_lag)
z <- matnorm(n_subject, n_covariates)

sizes <- runif(n_taxa, .1, 10)
baselines <- rgamma(n_taxa, 40, 4)
x <- generate_samples(step_generator, nbinom_sampler(sizes, baselines), theta0, w, z)
```

### Postprocess

```{r}
w_df <- map_dfr(w, ~ as_tibble(.), .id = "subject") |>
  pivot_longer(-subject, names_to = "time", values_to = "w") |>
  mutate(
    time = as.integer(str_remove(time, "V")),
    value = w,
    sample = str_c("sam", row_number())
  )
```

```{r}
for (i in seq_along(x)) {
  x[[i]] <- x[[i]][, -seq_len(n_lag)]
}

reads <- do.call(cbind, x)
colnames(reads) <- w_df |>
  filter(time > n_lag) |>
  pull(sample)
reads <- t(reads)
```


```{r}
subject_data <- z |>
  as_tibble() |>
  mutate(subject = row_number())

metadata <- expand.grid(
    time = seq_len(n_time),
    subject = seq_len(n_subject)
  ) |>
  mutate(sample = str_c("sam", row_number())) |>
  filter(time > n_lag) |>
  mutate(time = time - n_time / 2)

interventions <- w_df |>
  filter(time > n_lag) |>
  pull(w, sample) |>
  as.matrix()
colnames(interventions) <- str_c("P", seq_len(n_perturb))
```
```{r}
taxa_ids <- c(str_c("internal", seq_len(n_taxa), rownames(x[[1]])))
taxonomy <- create_tree(2 * n_taxa + 1, 2) |>
  activate(edges) |>
  mutate(
    tax_name = taxa_ids[to], 
    name = tax_name,
    kingdom = "bacteria",
    phylum = NA,
    sequence = NA,
    class = NA,
    order = NA,
    family = NA,
    genus = NA,
    species = NA
  ) |>
  as_tibble() |>
  rename(tax_id = to, parent_id = from) |>
  filter(!str_detect(tax_name, "internal")) |>
  select(tax_id, parent_id, everything())
```

```{r}
save(reads, interventions, metadata, subject_data, taxonomy, nonnull_taxa, file = output_path)
```

```{r, eval = FALSE}
for (i in seq_len(768)) {
  if (i %% 10 == 0) {
    print(glue("{i}/768"))
  }
  rmarkdown::render("simulation_data.Rmd", params = list(run_id = i), quiet = TRUE)
}
```
