---
title: "Untitled"
output: 
  html_document:
    highlight: "kate"
params:
  outputs_dir: "../data/simulation_output/"
  outputs_filter: "*rda"
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
params <- list(outputs_dir = "/Users/teg14/repos/microbiome_interventions/data/simulation_output/", outputs_filter = "*rda")
```

```{r}
library(glue)
library(fs)
library(tidyverse)
library(tfPaper)
library(egg)
```


### Inferential Results

```{r, fig.height = 6, fig.width = 8} 

my_theme <- function() {
  th <- theme_minimal() +
    theme(
      panel.grid.minor = element_blank(),
      panel.background = element_rect(fill = "#f7f7f7"),
      legend.box.background = element_rect(color = "black"),
      #plot.background = element_rect(fill = "lightgray"),
      panel.border = element_rect(fill = NA, color = "#0c0c0c", size = 0.6),
      axis.text = element_text(size = 14),
      axis.title = element_text(size = 16),
      legend.position = "bottom"
    )
}



theme_set(my_theme())





tag_facet2 <- function(p, open = "(", close = ")", tag_pool = letters, x = -Inf, y = Inf, 
    hjust = -0.5, vjust = 1.5, fontface = 2, family = "", ...) {

    gb <- ggplot_build(p)
    lay <- gb$layout$layout
    tags <- cbind(lay, label = paste0(open, tag_pool[lay$PANEL], close), x = x, y = y)
    p + geom_text(data = tags, aes_string(x = "x", y = "y", label = "label"), ..., hjust = hjust, 
        vjust = vjust, fontface = fontface, family = family, inherit.aes = FALSE)
}

testing_results <- readRDS("testing_results.rds")


pal <- c("#6D0FF2", "#B99AD9","#ffecf2",
 "#A65300", "#FFB808","#FFFFAD",
 "#007D30", "#00FF65", "#C4FFDB")



testing_results |>
  filter(type == "marginal", normalization == "DESeq2-asinh", lag== 1, method=="mirror") |>
  mutate(
    prop_nonnull = glue("{100 * prop_nonnull}% nonnull"),
    signal_B = glue("b = {signal_B}"),
    baseline_lambda = glue("lambda = {baseline_lambda}"),
    phylo_alpha = glue("alpha = {phylo_alpha}"),
    lag = glue("Lag {lag}"),
    #method = ifelse(method == "avg", "Pre/Post\nt-test", method),
    #normalization = case_match(normalization, "DESeq2-asinh"),
    n_taxa = glue("{n_taxa} taxa")
  ) |>
  ggplot() +
  geom_vline(xintercept = 0.2, col = "#E0E0E0", linewidth = 1) +
  geom_point(aes(fdp, power, shape = signal_B), size = 4) +
  geom_point(aes(fdp, power, shape = signal_B, col = interaction(prop_nonnull, n_taxa, sep = ", ")), size = 3, alpha = 0.95) +
  scale_color_manual(values = pal) +
  scale_y_continuous(breaks = c(0, .25, .5,.75,  1.0)) +
  scale_x_continuous(breaks = c(0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.8)) +
  guides(color = guide_legend(nrow = 3)) +
  facet_grid(n_taxa ~  prop_nonnull ) +
  #annotate('text', label = LETTERS[1:8], x=0, y=.75) +
  labs(x = "False Discovery Proportion", y = "Power", col = "Color", shape = "Signal /n Strength") +
  #tag_facet() +
  guides(shape = guide_legend(ncol = 1)) +
  theme(
    axis.text = element_text(size = 10),
    strip.text = element_text(size = 14),
    strip.text.y = element_text(angle = 0, size = 14),
    panel.spacing.y = unit(0.5, "line"),
    panel.spacing.x = unit(0.5, "line"),
    legend.justification = c("left", "bottom"),
    legend.box.background = element_rect(fill = "gray95", colour = "black")
  )->p

tag_facet2(p,hjust = -0.2, vjust=1.1, open="",close="",fontface = 2, size=5)

ggsave(glue("fig1.pdf"), height = 6, width = 8)

```

```{r, fig.height = 6, fig.width = 10} 
pal <- c("#6D0FF2", "#B99AD9","#ffecf2",
 "#A65300", "#FFB808","#FFFFAD",
 "#007D30", "#00FF65", "#C4FFDB")

testing_results |>
  filter(type == "marginal", normalization == "DESeq2-asinh", lag== 1, method=="mirror") |>
  mutate(
    prop_nonnull = glue("{100 * prop_nonnull}% nonnull"),
    signal_B = glue("b = {signal_B}"),
    baseline_lambda = glue("lambda = {baseline_lambda}"),
    phylo_alpha = glue("alpha = {phylo_alpha}"),
    lag = glue("Lag {lag}"),
    #method = ifelse(method == "avg", "Pre/Post\nt-test", method),
    #normalization = case_match(normalization, "DESeq2-asinh"),
    n_taxa = glue("{n_taxa} taxa")
  ) |>
  ggplot() +
  geom_vline(xintercept = 0.2, col = "#E0E0E0", linewidth = 1) +
  geom_point(aes(fdp, power, shape = signal_B), size = 4) +
  geom_point(aes(fdp, power, shape = signal_B, col = interaction(prop_nonnull, n_taxa, sep = ", ")), size = 3, alpha = .95) +
  scale_color_manual(values = pal) +
  scale_y_continuous(breaks = c(0, .25, .5,.75,  1)) +
  scale_x_continuous(breaks = c(0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.8)) +
  guides(color = guide_legend(nrow = 3)) +
  facet_grid(normalization + phylo_alpha + signal_B ~ lag + prop_nonnull + reorder(method, fdp)) +
  labs(x = "False Discovery Proportion", y = "Power", col = "Lag", shape = "Signal Strength") +
  theme(
    axis.text = element_text(size = 10),
    strip.text = element_text(size = 14),
    strip.text.y = element_text(angle = 0, size = 14),
    panel.spacing.y = unit(0.5, "line"),
    panel.spacing.x = unit(0.5, "line"),
    legend.justification = c("left", "bottom"),
    legend.box.background = element_rect(fill = "gray95", colour = "black")
  ) ->p

tag_facet2(p,hjust = -0.2, vjust=1.1, open="",close="",fontface = 2, size=5)

ggsave(glue("fig2.pdf"), height = 6, width = 10)
```